# Hudo — Build Foundation Document
**Version 1.0**
**Generated from PRD v1.1**
**Date: 2026-02-20**

> This document is the single reference for everything required before Sprint 0 feature code begins. It covers three things: the locked tech stack with all versions and key decisions, the complete Supabase database schema as migration-ready SQL, and the agent task list format recommendation with the full Sprint 0 task list in agent-consumable format.

---

## Part 1: Tech Stack — Locked Decisions

### 1.1 Stack Reference

| Layer | Technology | Version / Detail |
|---|---|---|
| Frontend framework | Next.js | 14.x, App Router, TypeScript strict mode |
| UI components | Shadcn UI | Latest stable; Radix UI primitives underneath |
| Styling | Tailwind CSS | 3.x (Shadcn dependency) |
| Auth | Supabase Auth | Email/password only. Social providers disabled. |
| Database | Supabase (PostgreSQL) | RLS enabled on all tables |
| Realtime | Supabase Realtime | Scoped subscriptions per `video_version_id` |
| Storage | Cloudflare R2 | Private bucket, signed URLs, CORS restricted to app domain |
| Email | Resend | Transactional: invites, notification digests |
| Payments | Stripe | Stripe Tax for UK VAT. Customer Portal for self-serve billing. |
| Error monitoring | Sentry | Next.js SDK |
| Product analytics | PostHog | Consent-gated. No events fire before cookie consent. |
| Hosting | Vercel | Edge config, Vercel Cron for notification batching |
| CDN / edge | Cloudflare | Via R2 and Vercel Edge |

---

### 1.2 Key Architectural Decisions

**Video never touches Vercel.** All uploads go directly from the browser to R2 via presigned URLs. All playback URLs are generated by a Next.js API route acting as a signing proxy. The direct R2 object URL is never exposed to any client.

**No transcoding.** Videos are stored and played back as-is. HTML5 native playback only. Accepted formats: MP4, MOV. Max file size: 10GB. The signing proxy handles URL generation; there is no processing pipeline.

**Multi-tenancy via memberships table, not `agency_id` on users.** A user can belong to multiple agencies. RLS policies must reflect this — agency context is derived from the `memberships` table for every query.

**Guests have zero Supabase access.** All guest data (video, comments) is served through the signing proxy API route. Guest tokens are validated server-side; the guest page never touches Supabase directly.

**Rate limiting is handled at the Next.js API layer** using an upstash/redis-compatible approach or Vercel's built-in edge rate limiting. All rate-limited endpoints return 429 with `Retry-After`.

**Stripe keys never reach the client bundle.** All Stripe server calls are in API routes or server components only. The publishable key is the only Stripe value exposed to the client.

**Observability:** Sentry for errors, PostHog for product analytics (consent-gated). Decision on which to prioritise deferred — both are included in the stack but PostHog requires explicit cookie consent before any events fire.

---

### 1.3 Environment Structure

Three environments. All infrastructure is fully separated per environment.

| Environment | Supabase | R2 Bucket | Vercel | Stripe |
|---|---|---|---|---|
| Development | `hudo-dev` project | `hudo-dev` | Preview deployments | Test mode restricted key |
| Staging | `hudo-staging` project | `hudo-staging` | Staging deployment | Test mode restricted key |
| Production | `hudo-prod` project | `hudo-prod` | Production deployment | Live key |

Environment variables are scoped per Vercel environment group. No production secret ever touches development.

---

### 1.4 Branching and Deployment

- All code in a single GitHub repository
- Feature branches created off `main` using Git worktrees: `feat/[task-id]-[short-description]`
- PRs trigger Vercel preview deployments automatically
- Merging to `main` deploys to production
- GitHub Actions runs: lint, type-check, unit tests, RLS tests on every PR
- Codex review agent runs on every PR and posts a structured review comment
- Branch protection on `main` requires passing CI + at least one approved review

---

### 1.5 Security Headers

Set in `next.config.js` for all responses:

```
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.stripe.com https://app.posthog.com; img-src 'self' data: blob:; media-src blob:; frame-src https://js.stripe.com;
Strict-Transport-Security: max-age=63072000; includeSubDomains; preload
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
Referrer-Policy: strict-origin-when-cross-origin
```

Session cookies: `SameSite=Lax; Secure; HttpOnly`.

---

### 1.6 Rate Limits Reference

| Endpoint | Limit |
|---|---|
| `POST /api/auth/signin` | 10 per IP per 15 minutes |
| `POST /api/auth/reset-password` | 5 per IP per hour |
| `POST /api/upload/presign` | 10 per user per hour |
| `POST /api/comments` | 60 per user per hour |
| `GET /api/guest/:token` | 20 per IP per minute |

All return `429` with `Retry-After` header on limit exceeded.

---

## Part 2: Database Schema

### 2.1 Notes on the Schema

- All tables use UUID primary keys
- All timestamps are `timestamptz` stored in UTC
- RLS is enabled on every table
- The `users` table mirrors Supabase auth — `id` matches `auth.users.id`
- Agency context is always derived from `memberships`, never assumed from a column on `users`
- Indexes are created in the same migration as the tables they reference
- `audit_log` has no update or delete policy — inserts only

---

### 2.2 Full Migration SQL

```sql
-- ============================================================
-- HUDO — INITIAL SCHEMA MIGRATION
-- Run against: Supabase dev, staging, and production
-- ============================================================

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================
-- AGENCIES
-- ============================================================

CREATE TABLE agencies (
  id                     uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  name                   text NOT NULL,
  slug                   text NOT NULL UNIQUE,
  plan                   text NOT NULL DEFAULT 'freemium'
                           CHECK (plan IN ('freemium', 'starter', 'studio', 'agency_pro')),
  stripe_customer_id     text,
  stripe_subscription_id text,
  subscription_status    text NOT NULL DEFAULT 'active'
                           CHECK (subscription_status IN ('active', 'trialing', 'past_due', 'canceled')),
  storage_usage_bytes    bigint NOT NULL DEFAULT 0,
  storage_limit_bytes    bigint NOT NULL DEFAULT 5368709120, -- 5GB default (freemium)
  legal_name             text,
  billing_address        jsonb,
  vat_number             text,
  dpa_accepted_at        timestamptz,
  dpa_accepted_ip        text,
  created_at             timestamptz NOT NULL DEFAULT now()
);

-- ============================================================
-- USERS
-- (mirrors auth.users — id is the Supabase auth user UUID)
-- ============================================================

CREATE TABLE users (
  id          uuid PRIMARY KEY, -- matches auth.users.id
  email       text NOT NULL UNIQUE,
  full_name   text NOT NULL,
  avatar_url  text,
  created_at  timestamptz NOT NULL DEFAULT now()
);

-- ============================================================
-- MEMBERSHIPS
-- (multi-tenancy join table — a user can belong to many agencies)
-- ============================================================

CREATE TABLE memberships (
  id         uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id    uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  agency_id  uuid NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  role       text NOT NULL
               CHECK (role IN ('owner', 'admin_agent', 'agent', 'talent')),
  created_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE (user_id, agency_id)
);

CREATE INDEX ON memberships (user_id);
CREATE INDEX ON memberships (agency_id);

-- ============================================================
-- INVITATIONS
-- ============================================================

CREATE TABLE invitations (
  id           uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id    uuid NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  invited_by   uuid NOT NULL REFERENCES users(id),
  email        text NOT NULL,
  role         text NOT NULL
                 CHECK (role IN ('admin_agent', 'agent', 'talent')),
  token_hash   text NOT NULL UNIQUE, -- SHA-256 hash of plaintext token; never store plaintext
  expires_at   timestamptz NOT NULL,
  accepted_at  timestamptz,
  created_at   timestamptz NOT NULL DEFAULT now()
);

-- ============================================================
-- VIDEOS
-- ============================================================

CREATE TABLE videos (
  id                uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id         uuid NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  talent_id         uuid NOT NULL REFERENCES users(id),
  title             text NOT NULL,
  status            text NOT NULL DEFAULT 'draft'
                      CHECK (status IN ('draft', 'pending_review', 'in_review', 'changes_requested', 'approved')),
  active_version_id uuid, -- FK to video_versions added after that table is created
  created_at        timestamptz NOT NULL DEFAULT now(),
  updated_at        timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX ON videos (agency_id);

-- ============================================================
-- VIDEO VERSIONS
-- ============================================================

CREATE TABLE video_versions (
  id               uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  video_id         uuid NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
  agency_id        uuid NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  version_number   integer NOT NULL,
  r2_key           text NOT NULL,
  file_size_bytes  bigint NOT NULL,
  duration_seconds integer, -- nullable; populated post-upload
  uploaded_by      uuid NOT NULL REFERENCES users(id),
  created_at       timestamptz NOT NULL DEFAULT now(),
  UNIQUE (video_id, version_number)
);

CREATE INDEX ON video_versions (video_id);

-- Add FK from videos to video_versions now that the table exists
ALTER TABLE videos
  ADD CONSTRAINT videos_active_version_id_fkey
  FOREIGN KEY (active_version_id) REFERENCES video_versions(id);

-- ============================================================
-- COMMENTS
-- ============================================================

CREATE TABLE comments (
  id                    uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  video_version_id      uuid NOT NULL REFERENCES video_versions(id) ON DELETE CASCADE,
  agency_id             uuid NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  user_id               uuid NOT NULL REFERENCES users(id),
  content               text NOT NULL CHECK (char_length(content) <= 2000),
  comment_type          text NOT NULL CHECK (comment_type IN ('point', 'range')),
  timestamp_seconds     numeric NOT NULL,
  end_timestamp_seconds numeric, -- nullable; only for range comments
  parent_id             uuid REFERENCES comments(id), -- nullable; max depth 1
  resolved              boolean NOT NULL DEFAULT false,
  resolved_at           timestamptz,
  resolved_by           uuid REFERENCES users(id),
  deleted_at            timestamptz, -- soft delete
  created_at            timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX ON comments (video_version_id);
CREATE INDEX ON comments (resolved);

-- ============================================================
-- NOTIFICATIONS
-- ============================================================

CREATE TABLE notifications (
  id            uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id     uuid NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  recipient_id  uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type          text NOT NULL
                  CHECK (type IN ('new_comment', 'comment_resolved', 'status_changed', 'invitation_accepted')),
  video_id      uuid REFERENCES videos(id),
  comment_id    uuid REFERENCES comments(id),
  read_at       timestamptz,
  created_at    timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX ON notifications (user_id);

-- ============================================================
-- NOTIFICATION PREFERENCES
-- ============================================================

CREATE TABLE notification_preferences (
  user_id                uuid PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  email_enabled          boolean NOT NULL DEFAULT true,
  batch_window_minutes   integer NOT NULL DEFAULT 15
                           CHECK (batch_window_minutes IN (5, 15, 30, 60))
);

-- ============================================================
-- GUEST LINKS
-- ============================================================

CREATE TABLE guest_links (
  id               uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  video_id         uuid NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
  agency_id        uuid NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  video_version_id uuid REFERENCES video_versions(id),
  token_hash       text NOT NULL UNIQUE, -- SHA-256 hash of plaintext token; never store plaintext
  created_by       uuid NOT NULL REFERENCES users(id),
  expires_at       timestamptz,
  revoked_at       timestamptz,
  view_count       integer NOT NULL DEFAULT 0,
  last_viewed_at   timestamptz,
  created_at       timestamptz NOT NULL DEFAULT now()
);

-- ============================================================
-- AUDIT LOG
-- (immutable — insert only, no update/delete via API)
-- ============================================================

CREATE TABLE audit_log (
  id             uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id      uuid NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  actor_id       uuid, -- nullable after user erasure
  actor_name     text NOT NULL, -- denormalised; replaced with "Deleted User" on erasure
  action         text NOT NULL,
    -- valid values: status_changed, version_uploaded, invitation_sent, invitation_accepted,
    --               role_changed, guest_link_created, guest_link_revoked,
    --               billing_plan_changed, billing_payment_failed
  resource_type  text NOT NULL,
    -- valid values: video, comment, membership, guest_link, billing
  resource_id    uuid NOT NULL,
  metadata       jsonb,
  created_at     timestamptz NOT NULL DEFAULT now()
);

-- ============================================================
-- ROW LEVEL SECURITY
-- ============================================================

-- Enable RLS on all tables
ALTER TABLE agencies              ENABLE ROW LEVEL SECURITY;
ALTER TABLE users                 ENABLE ROW LEVEL SECURITY;
ALTER TABLE memberships           ENABLE ROW LEVEL SECURITY;
ALTER TABLE invitations           ENABLE ROW LEVEL SECURITY;
ALTER TABLE videos                ENABLE ROW LEVEL SECURITY;
ALTER TABLE video_versions        ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments              ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications         ENABLE ROW LEVEL SECURITY;
ALTER TABLE notification_preferences ENABLE ROW LEVEL SECURITY;
ALTER TABLE guest_links           ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_log             ENABLE ROW LEVEL SECURITY;

-- ---- AGENCIES ----
-- Users can read agencies they are members of
CREATE POLICY "agency_select" ON agencies
  FOR SELECT USING (
    id IN (
      SELECT agency_id FROM memberships WHERE user_id = auth.uid()
    )
  );

-- Only system/service role inserts agencies (via registration API route)
-- No direct client insert/update/delete

-- ---- USERS ----
-- Users can read their own record
CREATE POLICY "users_select_self" ON users
  FOR SELECT USING (id = auth.uid());

-- Agents/owners can read users in their agency
CREATE POLICY "users_select_agency" ON users
  FOR SELECT USING (
    id IN (
      SELECT m2.user_id FROM memberships m2
      WHERE m2.agency_id IN (
        SELECT agency_id FROM memberships WHERE user_id = auth.uid()
      )
    )
  );

-- Users can update their own record
CREATE POLICY "users_update_self" ON users
  FOR UPDATE USING (id = auth.uid());

-- ---- MEMBERSHIPS ----
CREATE POLICY "memberships_select" ON memberships
  FOR SELECT USING (
    agency_id IN (
      SELECT agency_id FROM memberships WHERE user_id = auth.uid()
    )
  );

-- ---- INVITATIONS ----
CREATE POLICY "invitations_select" ON invitations
  FOR SELECT USING (
    agency_id IN (
      SELECT agency_id FROM memberships
      WHERE user_id = auth.uid()
      AND role IN ('owner', 'admin_agent', 'agent')
    )
  );

-- ---- VIDEOS ----
-- Agents/owners/admins: all videos in their agency
CREATE POLICY "videos_select_agents" ON videos
  FOR SELECT USING (
    agency_id IN (
      SELECT agency_id FROM memberships
      WHERE user_id = auth.uid()
      AND role IN ('owner', 'admin_agent', 'agent')
    )
  );

-- Talent: only their own videos
CREATE POLICY "videos_select_talent" ON videos
  FOR SELECT USING (
    talent_id = auth.uid()
    AND agency_id IN (
      SELECT agency_id FROM memberships WHERE user_id = auth.uid()
    )
  );

-- ---- VIDEO VERSIONS ----
CREATE POLICY "video_versions_select" ON video_versions
  FOR SELECT USING (
    video_id IN (
      SELECT id FROM videos
      -- relies on videos RLS above; this catches users who can see the video
    )
    AND agency_id IN (
      SELECT agency_id FROM memberships WHERE user_id = auth.uid()
    )
  );

-- ---- COMMENTS ----
CREATE POLICY "comments_select" ON comments
  FOR SELECT USING (
    agency_id IN (
      SELECT agency_id FROM memberships WHERE user_id = auth.uid()
    )
  );

-- ---- NOTIFICATIONS ----
CREATE POLICY "notifications_select" ON notifications
  FOR SELECT USING (recipient_id = auth.uid());

-- ---- NOTIFICATION PREFERENCES ----
CREATE POLICY "notification_prefs_select" ON notification_preferences
  FOR SELECT USING (user_id = auth.uid());

CREATE POLICY "notification_prefs_update" ON notification_preferences
  FOR UPDATE USING (user_id = auth.uid());

-- ---- GUEST LINKS ----
-- Only agents/owners can select guest links
CREATE POLICY "guest_links_select" ON guest_links
  FOR SELECT USING (
    agency_id IN (
      SELECT agency_id FROM memberships
      WHERE user_id = auth.uid()
      AND role IN ('owner', 'admin_agent', 'agent')
    )
  );

-- ---- AUDIT LOG ----
-- Owners and admin agents can read; no one can update or delete via client
CREATE POLICY "audit_log_select" ON audit_log
  FOR SELECT USING (
    agency_id IN (
      SELECT agency_id FROM memberships
      WHERE user_id = auth.uid()
      AND role IN ('owner', 'admin_agent')
    )
  );

-- No update or delete policy on audit_log — inserts only, via service role in API routes
```

---

### 2.3 Storage Limit Reference

Plan limits to use when setting `storage_limit_bytes` on agency creation or plan upgrade:

| Plan | `storage_limit_bytes` |
|---|---|
| freemium | 5,368,709,120 (5 GB) |
| starter | 53,687,091,200 (50 GB) |
| studio | 214,748,364,800 (200 GB) |
| agency_pro | 1,099,511,627,776 (1 TB) |

---

### 2.4 Plan Seat Limits

Enforced at the API layer (not via database constraints):

| Plan | Max Agents | Max Talent |
|---|---|---|
| freemium | 1 | 5 |
| starter | 5 | 50 |
| studio | 15 | 200 |
| agency_pro | unlimited | unlimited |

---

## Part 3: Agent Task List

### 3.1 Recommended Format

**Recommendation: One markdown file per sprint, tasks as structured blocks with checkbox status tracking.**

Rationale: Claude Code agents need to read a task, understand its full context, and know exactly what files to touch and what done looks like. A flat checklist loses structure. Separate files per task creates too much file navigation. One file per sprint gives agents a contained scope — they read one file, find their task, and have everything needed to execute. Checkbox status (`[ ]` → `[x]`) gives a human-readable progress view without requiring a separate tracker.

Each task block follows the format defined in PRD Section 6.4, with one addition: a `FILES` hint listing the expected files the agent will create or modify. This prevents agents from creating arbitrary file structures.

---

### 3.2 Sprint 0 Task List

**Goal:** Repo, infrastructure, environments, and schema are ready. No feature code. Sprint gate: local dev runs, all three Supabase environments have the schema applied, Vercel preview deploys on PR.

Save this as `tasks/sprint-0.md` in the repository root.

---

```markdown
# Sprint 0 — Infrastructure & Schema
**Status: Ready for execution**
**Gate:** Local dev runs end-to-end. Schema applied to dev, staging, and prod. Vercel preview deploys on PR. CI passes on an empty commit.

---

## Tasks

---

- [ ] **S0-INFRA-001** — Initialise repository and Next.js project

TASK_ID: S0-INFRA-001
TITLE: Initialise repository and Next.js project
BRANCH: feat/s0-infra-001-repo-init
STATUS: not_started
BLOCKED_BY: none
ACCEPTANCE_CRITERIA:
  - Next.js 14 project created with App Router and TypeScript strict mode
  - Shadcn UI initialised (all default components available)
  - Tailwind CSS configured
  - ESLint and Prettier configured with rules enforced in CI
  - `.env.example` lists all required environment variables with descriptions, no values
  - `README.md` describes local setup steps
  - Git worktree workflow documented in `CONTRIBUTING.md`
  - Project runs locally with `pnpm dev` and renders default page
FILES:
  - package.json
  - next.config.js
  - tsconfig.json
  - tailwind.config.ts
  - .eslintrc.json
  - .prettierrc
  - .env.example
  - README.md
  - CONTRIBUTING.md
NOTES: Use pnpm as package manager. Node 20 LTS. Do not install any feature dependencies yet — only project scaffolding.

---

- [ ] **S0-INFRA-002** — Configure GitHub Actions CI

TASK_ID: S0-INFRA-002
TITLE: Configure GitHub Actions CI pipeline
BRANCH: feat/s0-infra-002-ci
STATUS: not_started
BLOCKED_BY: S0-INFRA-001
ACCEPTANCE_CRITERIA:
  - CI runs on every PR and push to main
  - Steps: install dependencies, lint, type-check, run tests
  - CI passes on an empty test suite (no tests yet)
  - Branch protection rule on main documented in README (must be enabled manually in GitHub settings)
FILES:
  - .github/workflows/ci.yml
NOTES: Use pnpm in CI. Cache pnpm store between runs.

---

- [ ] **S0-INFRA-003** — Configure Vercel deployment

TASK_ID: S0-INFRA-003
TITLE: Configure Vercel project and environment variable structure
BRANCH: feat/s0-infra-003-vercel
STATUS: not_started
BLOCKED_BY: S0-INFRA-001
ACCEPTANCE_CRITERIA:
  - Vercel project created and linked to GitHub repo
  - Preview deployments trigger on PR
  - Production deployment triggers on merge to main
  - Three Vercel environment variable groups configured: development, preview, production
  - All variables from .env.example represented in each group (values can be placeholder for now)
  - Deployment documented in README
FILES:
  - vercel.json (if needed for config)
  - README.md (updated)
NOTES: Do not store any secrets in the repo. Environment variables are set via Vercel dashboard.

---

- [ ] **S0-INFRA-004** — Configure security headers

TASK_ID: S0-INFRA-004
TITLE: Add security headers to Next.js config
BRANCH: feat/s0-infra-004-security-headers
STATUS: not_started
BLOCKED_BY: S0-INFRA-001
ACCEPTANCE_CRITERIA:
  - All five required headers present on every response (see PRD Section 5.5)
  - CSP allows: self, Supabase, Stripe, PostHog, Sentry
  - Headers verified with curl on local dev and Vercel preview
  - Session cookies configured: SameSite=Lax; Secure; HttpOnly
FILES:
  - next.config.js
NOTES: CSP must not block Supabase Realtime websocket (wss://). Test with browser devtools network tab.

---

- [ ] **S0-DB-001** — Provision Supabase environments

TASK_ID: S0-DB-001
TITLE: Create and configure Supabase dev, staging, and production projects
BRANCH: feat/s0-db-001-supabase-envs
STATUS: not_started
BLOCKED_BY: S0-INFRA-001
ACCEPTANCE_CRITERIA:
  - Three Supabase projects created: hudo-dev, hudo-staging, hudo-prod
  - Each project has its connection string, anon key, and service role key stored in the correct Vercel environment group
  - RLS is enabled at the project level for all three environments
  - Each project has email auth enabled; social providers disabled
  - Supabase CLI configured locally and connected to hudo-dev
FILES:
  - supabase/config.toml
  - .env.example (updated with Supabase variable names)
NOTES: Service role key must never appear in client-side code or be committed to git. Use Supabase CLI for local development linked to hudo-dev.

---

- [ ] **S0-DB-002** — Write and apply initial schema migration

TASK_ID: S0-DB-002
TITLE: Write initial schema migration and apply to all three environments
BRANCH: feat/s0-db-002-schema
STATUS: not_started
BLOCKED_BY: S0-DB-001
ACCEPTANCE_CRITERIA:
  - Migration file covers all 11 tables defined in PRD Section 4 and Build Foundation Part 2
  - All indexes from PRD Section 4.3 are created
  - RLS is enabled on all tables
  - All RLS policies from Build Foundation Part 2 are applied
  - Migration applied successfully to hudo-dev, hudo-staging, and hudo-prod
  - Supabase CLI can run migration from scratch against a clean project: `supabase db reset` succeeds
  - No table, column, or policy is missing relative to the spec
FILES:
  - supabase/migrations/0001_initial_schema.sql
NOTES: Copy the SQL from the Build Foundation Document exactly. Do not invent columns or tables not in the spec. The migration must be idempotent where possible.

---

- [ ] **S0-DB-003** — Write RLS test suite scaffold

TASK_ID: S0-DB-003
TITLE: Create RLS test suite that will enforce policy coverage throughout the build
BRANCH: feat/s0-db-003-rls-tests
STATUS: not_started
BLOCKED_BY: S0-DB-002
ACCEPTANCE_CRITERIA:
  - Test suite in `tests/rls/` using Supabase's `pgTAP` or equivalent
  - Tests cover: cross-agency data access is impossible, talent cannot read other talent's videos, guests have no Supabase access, audit_log cannot be updated or deleted via client
  - Tests run in CI via GitHub Actions
  - All tests pass against the current schema
  - A comment in each test file explains which PRD policy it is enforcing
FILES:
  - tests/rls/agencies.test.sql (or .ts)
  - tests/rls/videos.test.sql
  - tests/rls/comments.test.sql
  - tests/rls/audit_log.test.sql
  - .github/workflows/ci.yml (updated to run RLS tests)
NOTES: Any future deletion of an RLS policy must cause at least one test here to fail. That is the purpose of this suite.

---

- [ ] **S0-STORAGE-001** — Configure Cloudflare R2 buckets

TASK_ID: S0-STORAGE-001
TITLE: Create and configure R2 buckets for all three environments
BRANCH: feat/s0-storage-001-r2-buckets
STATUS: not_started
BLOCKED_BY: S0-INFRA-001
ACCEPTANCE_CRITERIA:
  - Three R2 buckets created: hudo-dev, hudo-staging, hudo-prod
  - All buckets: private, no public bucket policy, no public fallback
  - CORS configured on all buckets: allow PUT uploads from app domain only
  - Object versioning enabled on all buckets
  - R2 API credentials (access key, secret key, account ID, bucket name) stored in correct Vercel environment groups
  - Verified: direct unsigned R2 URL returns 403
  - Verified: CORS rejects request from non-app domain
FILES:
  - docs/r2-setup.md (documents bucket config and CORS policy for reproducibility)
  - .env.example (updated with R2 variable names)
NOTES: CORS policy: `AllowedOrigins: [https://hudo.app, http://localhost:3000]`, `AllowedMethods: [PUT]`, `AllowedHeaders: [Content-Type]`. Do not allow GET in CORS — playback goes through the signing proxy, not CORS.

---

- [ ] **S0-STORAGE-002** — Build R2 signing proxy (playback URL generation)

TASK_ID: S0-STORAGE-002
TITLE: Implement signing proxy API route for video playback URL generation
BRANCH: feat/s0-storage-002-signing-proxy
STATUS: not_started
BLOCKED_BY: S0-DB-002, S0-STORAGE-001
ACCEPTANCE_CRITERIA:
  - `GET /api/videos/:videoId/playback-url` returns a signed R2 URL with 15-minute expiry
  - Route validates: requesting user is authenticated and has access to the video (via memberships)
  - Direct R2 object URL is never returned to the client — only the signed URL
  - Unauthenticated requests return 401
  - Requests for videos the user cannot access return 403
  - Signed URL expires after 15 minutes (verified with manual test)
FILES:
  - app/api/videos/[videoId]/playback-url/route.ts
  - lib/r2.ts (R2 client and signing utility)
NOTES: Use AWS SDK v3 `@aws-sdk/client-s3` with `getSignedUrl` — R2 is S3-compatible. The R2 object URL must not appear in any response body, log, or error message.

---

- [ ] **S0-INFRA-005** — Configure Sentry

TASK_ID: S0-INFRA-005
TITLE: Install and configure Sentry for error monitoring
BRANCH: feat/s0-infra-005-sentry
STATUS: not_started
BLOCKED_BY: S0-INFRA-001
ACCEPTANCE_CRITERIA:
  - Sentry Next.js SDK installed and configured
  - Separate Sentry projects or DSNs for dev/staging/prod
  - Errors captured in both client and server components
  - Source maps uploaded on production build
  - A deliberate thrown error in a test route confirms Sentry receives it
  - Sentry DSN is an environment variable, not hardcoded
FILES:
  - sentry.client.config.ts
  - sentry.server.config.ts
  - sentry.edge.config.ts
  - next.config.js (updated with Sentry webpack plugin)
  - .env.example (updated)
NOTES: Do not enable Sentry session replay in MVP — it captures video frames and has GDPR implications.

---

- [ ] **S0-INFRA-006** — Configure PostHog

TASK_ID: S0-INFRA-006
TITLE: Install PostHog with cookie consent gate
BRANCH: feat/s0-infra-006-posthog
STATUS: not_started
BLOCKED_BY: S0-INFRA-001
ACCEPTANCE_CRITERIA:
  - PostHog installed but does NOT initialise or fire any events until cookie consent is granted
  - Cookie consent banner component created (non-functional UI only — wiring to PostHog is the criterion here)
  - Consent stored in localStorage key `hudo_cookie_consent`
  - On consent granted: PostHog initialises and begins capturing
  - On consent denied or not yet given: PostHog is completely silent (no network requests)
  - Verified: no PostHog network requests visible in devtools before consent
FILES:
  - lib/posthog.ts
  - components/cookie-consent-banner.tsx
  - .env.example (updated)
NOTES: The consent banner visual design is polished in Sprint 4. For Sprint 0 the requirement is correct behaviour, not visual finish.

---

## Sprint 0 Gate Checklist

- [ ] `pnpm dev` runs locally without errors
- [ ] `pnpm lint` and `pnpm type-check` pass
- [ ] CI passes on an empty PR
- [ ] Vercel preview deploys on PR open
- [ ] All three Supabase environments have the full schema applied
- [ ] `supabase db reset` runs successfully against a clean dev project
- [ ] All RLS tests pass
- [ ] All three R2 buckets are private; unsigned URLs return 403
- [ ] Signing proxy returns a working 15-minute signed URL
- [ ] Sentry receives errors from dev environment
- [ ] PostHog fires no events before cookie consent
- [ ] No secret or credential committed to git
```

---

### 3.3 How to Use This Task List with Claude Code

Each Claude Code agent session should be started with the following prompt pattern:

```
You are a build agent for the Hudo project. Your task is:

[paste the full task block here]

Rules:
- Read the task fully before writing any code
- Only create or modify the files listed in FILES
- Do not add dependencies not already in package.json without flagging it first
- Write the minimum code needed to satisfy the acceptance criteria — nothing more
- Write a test for every behaviour described in the acceptance criteria
- When done: commit, push the branch, and open a PR
- Set task STATUS to in_progress when you start, in_review when you push the PR

The full PRD is at [link]. The tech stack doc is at [link]. Refer to these if you need context beyond the task block.
```

Set STATUS to `in_progress` by checking the box and adding a note in the sprint file when the agent starts. When the PR is opened, set to `in_review`. When merged, check the box and mark `done`.

---

*End of Hudo Build Foundation Document v1.0*
*Part 1: Tech Stack | Part 2: Schema | Part 3: Sprint 0 Task List*
*Next: Sprint 1 task list to be generated after Sprint 0 gate passes.*
