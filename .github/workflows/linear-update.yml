name: Update Linear on PR / Push

on:
  push:
    branches:
      - 'feat/s*-*'
  pull_request:
    types: [closed, opened, reopened]

jobs:
  mark-in-progress:
    # Only on push to feature branches (not PR events)
    if: github.event_name == 'push'
    name: Mark task In Progress in Linear
    runs-on: ubuntu-latest
    steps:
      - name: Update Linear to In Progress (if pre-work state)
        env:
          BRANCH: ${{ github.ref_name }}
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          python3 - << 'PYEOF'
          import re, os, json, sys, urllib.request

          branch  = os.environ["BRANCH"]
          api_key = os.environ["LINEAR_API_KEY"]

          m = re.search(r's(\d+)-([a-z0-9]+)-(\d+)', branch)
          if not m:
              print(f"No task ID found in branch '{branch}' — skipping")
              sys.exit(0)

          task_id = f"S{m.group(1)}-{m.group(2).upper()}-{m.group(3)}"
          print(f"Task ID: {task_id}")

          headers = {"Authorization": api_key, "Content-Type": "application/json"}

          def gql(query, variables=None):
              payload = json.dumps({"query": query, "variables": variables or {}}).encode()
              req = urllib.request.Request("https://api.linear.app/graphql", data=payload, headers=headers)
              with urllib.request.urlopen(req) as resp:
                  data = json.loads(resp.read())
              if data.get("errors"):
                  raise RuntimeError(f"GraphQL error: {data['errors']}")
              return data["data"]

          search_result = gql(
              'query($q: String!) { searchIssues(term: $q) { nodes { id identifier title } } }',
              {"q": task_id}
          )
          nodes = search_result["searchIssues"]["nodes"]
          matching = [n for n in nodes if n["title"].upper().startswith(task_id)]
          if not matching:
              print(f"No Linear issue found for '{task_id}' — skipping")
              sys.exit(0)
          issue_id = matching[0]["id"]
          print(f"Found: {matching[0]['identifier']} — {matching[0]['title']}")

          # Check current state — only upgrade from pre-work states
          issue_data = gql("query($id: String!) { issue(id: $id) { team { id } state { name } } }", {"id": issue_id})
          current_state = issue_data["issue"]["state"]["name"].lower()
          team_id = issue_data["issue"]["team"]["id"]

          pre_work_states = {"backlog", "todo"}
          if current_state not in pre_work_states:
              print(f"Current state is '{issue_data['issue']['state']['name']}' — not downgrading to In Progress")
              sys.exit(0)

          states = gql("query($t: ID!) { workflowStates(filter: { team: { id: { eq: $t } } }) { nodes { id name } } }", {"t": team_id})["workflowStates"]["nodes"]
          target = next((s for s in states if s["name"].lower() == "in progress"), None)
          if not target:
              print(f"'In Progress' state not found. Available: {[s['name'] for s in states]}")
              sys.exit(1)

          result = gql(
              "mutation($id: String!, $sid: String!) { issueUpdate(id: $id, input: { stateId: $sid }) { issue { identifier state { name } } } }",
              {"id": issue_id, "sid": target["id"]}
          )
          issue = result["issueUpdate"]["issue"]
          print(f"✓ {task_id} ({issue['identifier']}) → {issue['state']['name']}")
          PYEOF

  mark-in-review:
    # Only on PR open/reopen, skip fork PRs
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      (github.event.action == 'opened' || github.event.action == 'reopened')
    name: Mark task In Review in Linear
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Update Linear to In Review
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python3 - << 'PYEOF'
          import re, os, json, sys, urllib.request

          branch  = os.environ["BRANCH"]
          api_key = os.environ["LINEAR_API_KEY"]

          m = re.search(r's(\d+)-([a-z0-9]+)-(\d+)', branch)
          if not m:
              print(f"No task ID found in branch '{branch}' — skipping")
              sys.exit(0)

          task_id = f"S{m.group(1)}-{m.group(2).upper()}-{m.group(3)}"
          print(f"Task ID: {task_id}")

          headers = {"Authorization": api_key, "Content-Type": "application/json"}

          def gql(query, variables=None):
              payload = json.dumps({"query": query, "variables": variables or {}}).encode()
              req = urllib.request.Request("https://api.linear.app/graphql", data=payload, headers=headers)
              with urllib.request.urlopen(req) as resp:
                  data = json.loads(resp.read())
              if data.get("errors"):
                  raise RuntimeError(f"GraphQL error: {data['errors']}")
              return data["data"]

          search_result = gql(
              'query($q: String!) { searchIssues(term: $q) { nodes { id identifier title } } }',
              {"q": task_id}
          )
          nodes = search_result["searchIssues"]["nodes"]
          matching = [n for n in nodes if n["title"].upper().startswith(task_id)]
          if not matching:
              print(f"No Linear issue found for '{task_id}' — skipping")
              sys.exit(0)
          issue_id = matching[0]["id"]
          print(f"Found: {matching[0]['identifier']} — {matching[0]['title']}")

          team_id = gql("query($id: String!) { issue(id: $id) { team { id } } }", {"id": issue_id})["issue"]["team"]["id"]
          states  = gql("query($t: ID!) { workflowStates(filter: { team: { id: { eq: $t } } }) { nodes { id name } } }", {"t": team_id})["workflowStates"]["nodes"]

          target = next((s for s in states if s["name"].lower() == "in review"), None)
          if not target:
              print(f"'In Review' state not found. Available: {[s['name'] for s in states]}")
              sys.exit(1)

          result = gql(
              "mutation($id: String!, $sid: String!) { issueUpdate(id: $id, input: { stateId: $sid }) { issue { identifier state { name } } } }",
              {"id": issue_id, "sid": target["id"]}
          )
          issue = result["issueUpdate"]["issue"]
          print(f"✓ {task_id} ({issue['identifier']}) → {issue['state']['name']}")

          identifier = issue["identifier"]  # e.g. "HUD-23"
          resolves_line = f"Resolves {identifier}"

          pr_body = os.environ.get("PR_BODY") or ""
          if resolves_line not in pr_body:
              new_body = (pr_body.rstrip() + f"\n\n{resolves_line}") if pr_body.strip() else resolves_line

              github_token = os.environ["GITHUB_TOKEN"]
              repo = os.environ["REPO"]
              pr_number = os.environ["PR_NUMBER"]

              patch_payload = json.dumps({"body": new_body}).encode()
              patch_req = urllib.request.Request(
                  f"https://api.github.com/repos/{repo}/pulls/{pr_number}",
                  data=patch_payload,
                  method="PATCH",
                  headers={
                      "Authorization": f"Bearer {github_token}",
                      "Accept": "application/vnd.github+json",
                      "X-GitHub-Api-Version": "2022-11-28",
                      "Content-Type": "application/json",
                  },
              )
              with urllib.request.urlopen(patch_req) as resp:
                  resp.read()
              print(f"✓ PR description updated with '{resolves_line}'")
          else:
              print(f"✓ PR description already contains '{resolves_line}' — skipping")
          PYEOF

  mark-done:
    # Only on PR merge, skip fork PRs
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      github.event.pull_request.merged == true
    name: Mark task Done in Linear
    runs-on: ubuntu-latest
    steps:
      - name: Update Linear to Done
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          python3 - << 'PYEOF'
          import re, os, json, sys, urllib.request

          branch  = os.environ["BRANCH"]
          api_key = os.environ["LINEAR_API_KEY"]

          m = re.search(r's(\d+)-([a-z0-9]+)-(\d+)', branch)
          if not m:
              print(f"No task ID found in branch '{branch}' — skipping")
              sys.exit(0)

          task_id = f"S{m.group(1)}-{m.group(2).upper()}-{m.group(3)}"
          print(f"Task ID: {task_id}")

          headers = {"Authorization": api_key, "Content-Type": "application/json"}

          def gql(query, variables=None):
              payload = json.dumps({"query": query, "variables": variables or {}}).encode()
              req = urllib.request.Request("https://api.linear.app/graphql", data=payload, headers=headers)
              with urllib.request.urlopen(req) as resp:
                  data = json.loads(resp.read())
              if data.get("errors"):
                  raise RuntimeError(f"GraphQL error: {data['errors']}")
              return data["data"]

          search_result = gql(
              'query($q: String!) { searchIssues(term: $q) { nodes { id identifier title } } }',
              {"q": task_id}
          )
          nodes = search_result["searchIssues"]["nodes"]
          matching = [n for n in nodes if n["title"].upper().startswith(task_id)]
          if not matching:
              print(f"No Linear issue found for '{task_id}' — skipping")
              sys.exit(0)
          issue_id = matching[0]["id"]
          print(f"Found: {matching[0]['identifier']} — {matching[0]['title']}")

          team_id = gql("query($id: String!) { issue(id: $id) { team { id } } }", {"id": issue_id})["issue"]["team"]["id"]
          states  = gql("query($t: ID!) { workflowStates(filter: { team: { id: { eq: $t } } }) { nodes { id name } } }", {"t": team_id})["workflowStates"]["nodes"]

          target = next((s for s in states if s["name"].lower() == "done"), None)
          if not target:
              print(f"'Done' state not found. Available: {[s['name'] for s in states]}")
              sys.exit(1)

          result = gql(
              "mutation($id: String!, $sid: String!) { issueUpdate(id: $id, input: { stateId: $sid }) { issue { identifier state { name } } } }",
              {"id": issue_id, "sid": target["id"]}
          )
          issue = result["issueUpdate"]["issue"]
          print(f"✓ {task_id} ({issue['identifier']}) → {issue['state']['name']}")
          PYEOF
