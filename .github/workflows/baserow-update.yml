name: Update Baserow on Merge

on:
  pull_request:
    types: [closed, opened, reopened]
    branches: [main]

jobs:
  update-baserow-on-open:
    if: github.event.action == 'opened' || github.event.action == 'reopened'
    name: Mark task In Review in Baserow
    runs-on: ubuntu-latest
    steps:
      - name: Extract task ID from branch name
        id: task
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          TASK_ID=$(python3 -c "
          import re, os
          branch = os.environ['BRANCH']
          m = re.search(r's(\d+)-([a-z0-9]+)-(\d+)', branch)
          if m:
              sprint, area, num = m.group(1), m.group(2).upper(), m.group(3)
              print(f'S{sprint}-{area}-{num}')
          ")
          echo "task_id=$TASK_ID" >> "$GITHUB_OUTPUT"

      - name: Update Baserow to In Review
        if: steps.task.outputs.task_id != ''
        env:
          BASEROW_DB_TOKEN: ${{ secrets.BASEROW_DB_TOKEN }}
          TASK_ID: ${{ steps.task.outputs.task_id }}
        run: |
          python3 - << 'PYEOF'
          import os, json, urllib.request
          token = os.environ["BASEROW_DB_TOKEN"]
          task_id = os.environ["TASK_ID"]
          table_id = "849304"
          base = "https://api.baserow.io/api"
          headers = {"Authorization": f"Token {token}", "Content-Type": "application/json"}
          req = urllib.request.Request(
              f"{base}/database/rows/table/{table_id}/?user_field_names=true&search={task_id}&size=10",
              headers=headers)
          with urllib.request.urlopen(req) as resp:
              data = json.loads(resp.read())
          row_id = next((r["id"] for r in data.get("results", []) if r.get("Name") == task_id), None)
          if not row_id:
              print(f"Task '{task_id}' not found in Baserow — skipping")
              raise SystemExit(0)
          payload = json.dumps({"Status": 5427488}).encode()  # In Review
          req = urllib.request.Request(
              f"{base}/database/rows/table/{table_id}/{row_id}/?user_field_names=true",
              data=payload, method="PATCH", headers=headers)
          with urllib.request.urlopen(req) as resp:
              result = json.loads(resp.read())
          print(f"✓ {task_id} → {result.get('Status', {}).get('value', '?')} (row {row_id})")
          PYEOF

  update-baserow:
    if: github.event.pull_request.merged == true
    name: Mark task Done in Baserow
    runs-on: ubuntu-latest
    steps:
      - name: Extract task ID from branch name
        id: task
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          TASK_ID=$(python3 -c "
          import re, os
          branch = os.environ['BRANCH']
          m = re.search(r's(\d+)-([a-z0-9]+)-(\d+)', branch)
          if m:
              sprint, area, num = m.group(1), m.group(2).upper(), m.group(3)
              print(f'S{sprint}-{area}-{num}')
          ")
          echo "task_id=$TASK_ID" >> "$GITHUB_OUTPUT"
          echo "Extracted task ID: $TASK_ID"

      - name: Update Baserow to Done
        if: steps.task.outputs.task_id != ''
        env:
          BASEROW_DB_TOKEN: ${{ secrets.BASEROW_DB_TOKEN }}
          TASK_ID: ${{ steps.task.outputs.task_id }}
        run: |
          python3 - << 'PYEOF'
          import os, json, urllib.request

          token = os.environ["BASEROW_DB_TOKEN"]
          task_id = os.environ["TASK_ID"]
          table_id = "849304"
          base = "https://api.baserow.io/api"
          headers = {"Authorization": f"Token {token}", "Content-Type": "application/json"}

          # Search for the row by Name field (= task ID)
          search_url = f"{base}/database/rows/table/{table_id}/?user_field_names=true&search={task_id}&size=10"
          req = urllib.request.Request(search_url, headers=headers)
          with urllib.request.urlopen(req) as resp:
              data = json.loads(resp.read())

          row_id = None
          for row in data.get("results", []):
              if row.get("Name") == task_id:
                  row_id = row["id"]
                  break

          if not row_id:
              print(f"Task '{task_id}' not found in Baserow — skipping")
              raise SystemExit(0)

          # Update Status to Done (option ID 5427489)
          update_url = f"{base}/database/rows/table/{table_id}/{row_id}/?user_field_names=true"
          payload = json.dumps({"Status": 5427489}).encode()
          req = urllib.request.Request(update_url, data=payload, method="PATCH", headers=headers)
          with urllib.request.urlopen(req) as resp:
              result = json.loads(resp.read())

          status = result.get("Status", {}).get("value", "unknown")
          print(f"✓ {task_id} → {status} (row {row_id})")
          PYEOF
